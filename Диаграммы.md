Создам для вас полную диаграмму авторизации с JWT токенами в формате Mermaid.

Полная диаграмма авторизации JWT

```mermaid
graph TB
    %% Стили для разных типов элементов
    classDef client fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef server fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef database fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef success fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px
    classDef error fill:#ffcdd2,stroke:#c62828,stroke-width:2px
    
    subgraph "Клиентское приложение"
        CLIENT[Клиент<br/>Web/Mobile App]
        STORE[Хранилище токенов<br/>LocalStorage/Cookies]
    end
    
    subgraph "Сервер авторизации"
        AUTH[Auth Handler]
        MIDDLEWARE[JWT Middleware]
        SERVICE[Auth Service]
        TOKEN_GEN[Генератор токенов]
    end
    
    subgraph "База данных"
        USERS[(Таблица пользователей)]
        REFRESH_TOKENS[(Таблица refresh токенов)]
    end
    
    %% Регистрация
    CLIENT -- "1. POST /register<br/>email, password" --> AUTH
    AUTH -- "2. Проверка данных" --> SERVICE
    SERVICE -- "3. Проверка существования<br/>пользователя" --> USERS
    USERS -- "4. Пользователь не существует" --> SERVICE
    SERVICE -- "5. Хеширование пароля" --> SERVICE
    SERVICE -- "6. Создание пользователя" --> USERS
    SERVICE -- "7. Запрос генерации токенов" --> TOKEN_GEN
    TOKEN_GEN -- "8. Генерация access token<br/>(15 минут)" --> SERVICE
    TOKEN_GEN -- "9. Генерация refresh token<br/>(7 дней)" --> SERVICE
    SERVICE -- "10. Сохранение refresh token" --> REFRESH_TOKENS
    AUTH -- "11. Возврат токенов<br/>access + refresh" --> CLIENT
    CLIENT -- "12. Сохранение токенов" --> STORE
    
    %% Логин
    CLIENT -- "A. POST /login<br/>email, password" --> AUTH
    AUTH -- "B. Проверка учетных данных" --> SERVICE
    SERVICE -- "C. Поиск пользователя" --> USERS
    USERS -- "D. Пользователь найден" --> SERVICE
    SERVICE -- "E. Проверка пароля<br/>bcrypt.compare()" --> SERVICE
    SERVICE -- "F. Успешная проверка" --> TOKEN_GEN
    
    %% Защищенный запрос
    CLIENT -- "I. Запрос к API<br/>Authorization: Bearer {token}" --> MIDDLEWARE
    MIDDLEWARE -- "J. Проверка JWT токена" --> MIDDLEWARE
    MIDDLEWARE -- "K. Токен валиден" --> API[Защищенный API]
    MIDDLEWARE -- "L. Токен истек<br/>401 + X-Token-Expired: true" --> CLIENT
    
    %% Обновление токена
    CLIENT -- "M. POST /refresh<br/>refresh token" --> AUTH
    AUTH -- "N. Проверка refresh token" --> SERVICE
    SERVICE -- "O. Валидация подписи<br/>и срока действия" --> SERVICE
    SERVICE -- "P. Поиск в базе" --> REFRESH_TOKENS
    REFRESH_TOKENS -- "Q. Токен найден<br/>и не истек" --> SERVICE
    SERVICE -- "R. Удаление старого<br/>refresh token" --> REFRESH_TOKENS
    SERVICE -- "S. Генерация новой пары" --> TOKEN_GEN
    AUTH -- "T. Возврат новых токенов" --> CLIENT
    
    %% Логаут
    CLIENT -- "X. POST /logout" --> AUTH
    AUTH -- "Y. Получение user ID<br/>из контекста" --> SERVICE
    SERVICE -- "Z. Удаление всех<br/>refresh токенов пользователя" --> REFRESH_TOKENS
    AUTH -- "AA. Успешный ответ" --> CLIENT
    CLIENT -- "AB. Очистка локальных<br/>токенов" --> STORE
    
    %% Применение стилей
    class CLIENT,STORE client
    class AUTH,MIDDLEWARE,SERVICE,TOKEN_GEN,API server
    class USERS,REFRESH_TOKENS database
```

Детальная последовательность действий

```mermaid
sequenceDiagram
    participant C as Клиент
    participant A as Auth Handler
    participant S as Auth Service
    participant T as Token Generator
    participant DB as Database
    participant M as Middleware
    participant API as Protected API

    %% Регистрация
    Note over C,S: Процесс регистрации
    C->>A: POST /register {email, password}
    A->>S: Register(email, password)
    S->>DB: Проверка существования пользователя
    DB-->>S: Пользователь не существует
    S->>S: HashPassword(password)
    S->>DB: CreateUser(user)
    S->>T: GenerateTokenPair(user)
    T->>T: Create Access Token (15min)
    T->>T: Create Refresh Token (7 days)
    T->>DB: SaveRefreshToken(refreshToken)
    T-->>S: TokenPair{access, refresh}
    S-->>A: AuthResponse
    A-->>C: 201 Created + Tokens
    C->>C: Сохранить токены в storage

    %% Логин
    Note over C,S: Процесс входа
    C->>A: POST /login {email, password}
    A->>S: Login(email, password)
    S->>DB: GetUserByEmail(email)
    DB-->>S: User
    S->>S: CheckPassword(password)
    S->>T: GenerateTokenPair(user)
    T-->>S: TokenPair
    S-->>A: AuthResponse
    A-->>C: 200 OK + Tokens

    %% Защищенный запрос - успешный
    Note over C,API: Защищенный запрос - токен валиден
    C->>M: GET /api/profile + Bearer Token
    M->>M: Verify JWT Signature
    M->>M: Check Expiration
    M->>DB: GetUserByEmail(from token)
    DB-->>M: User
    M->>API: Request with User Context
    API-->>M: Response
    M-->>C: 200 OK + Data

    %% Защищенный запрос - токен истек
    Note over C,API: Защищенный запрос - токен истек
    C->>M: GET /api/profile + Expired Token
    M->>M: Token Expired
    M-->>C: 401 Unauthorized + X-Token-Expired: true

    %% Автоматическое обновление токена
    Note over C,A: Автоматическое обновление
    C->>A: POST /refresh {refresh_token}
    A->>S: RefreshTokens(refresh_token)
    S->>S: ValidateRefreshToken
    S->>DB: GetRefreshToken(jti)
    DB-->>S: RefreshToken valid
    S->>DB: DeleteRefreshToken(old)
    S->>T: GenerateTokenPair(user)
    T-->>S: New TokenPair
    S-->>A: TokenPair
    A-->>C: 200 OK + New Tokens
    C->>C: Update stored tokens

    %% Логаут
    Note over C,DB: Процесс выхода
    C->>A: POST /logout + Bearer Token
    A->>M: Extract User from Context
    M-->>A: User
    A->>S: Logout(user.ID)
    S->>DB: DeleteUserRefreshTokens(userID)
    DB-->>S: Success
    S-->>A: Success
    A-->>C: 200 OK
    C->>C: Clear local tokens
```

Диаграмма состояний токенов

```mermaid
stateDiagram-v2
    [*] --> NoTokens
    
    state "Жизненный цикл токенов" as lifecycle
    state "Обработка ошибок" as errors
    
    NoTokens --> HasValidTokens : Успешный логин/регистрация
    NoTokens --> NoTokens : Неудачный логин
    
    state HasValidTokens {
        [*] --> AccessValid
        AccessValid --> AccessExpired : После 15 минут
        AccessExpired --> Refreshing : Автоматический запрос
        Refreshing --> AccessValid : Успешное обновление
        Refreshing --> RefreshExpired : Refresh token истек
    }
    
    AccessExpired --> NoTokens : Логаут
    AccessValid --> NoTokens : Логаут
    RefreshExpired --> NoTokens : Требуется перелогин
    
    state errors {
        InvalidToken --> NoTokens : Невалидная подпись
        TokenRevoked --> NoTokens : Токен отозван
        ServerError --> Retry : Ошибка сервера
        Retry --> HasValidTokens : Успешный retry
        Retry --> NoTokens : Много ошибок
    }
    
    HasValidTokens --> errors : Ошибка валидации
```

Архитектура безопасности

```mermaid
graph LR
    subgraph "Слой безопасности"
        JWT[JWT Токены]
        REFRESH[Refresh Tokens]
        BCrypt[Хеширование паролей]
        MIDDLEWARE[Проверка доступа]
    end
    
    subgraph "Типы токенов"
        ACCESS[Access Token<br/>Короткоживущий<br/>15 минут]
        REF[Refresh Token<br/>Долгоживущий<br/>7 дней]
    end
    
    subgraph "Хранение данных"
        CLIENT_STORE[Клиент<br/>LocalStorage]
        SERVER_DB[Сервер<br/>База данных]
    end
    
    subgraph "Защита"
        HTTPS[HTTPS Encryption]
        CORS[CORS Policy]
        RATE_LIMIT[Rate Limiting]
    end
    
    JWT --> ACCESS
    JWT --> REF
    ACCESS --> CLIENT_STORE
    REF --> CLIENT_STORE
    REF --> SERVER_DB
    BCrypt --> SERVER_DB
    MIDDLEWARE --> HTTPS
    MIDDLEWARE --> CORS
    MIDDLEWARE --> RATE_LIMIT
```

Поток данных между компонентами

```mermaid
flowchart TD
    START([Начало]) --> AUTH{Действие}
    
    AUTH --> REG[Регистрация]
    AUTH --> LOGIN[Вход]
    AUTH --> API[API Запрос]
    AUTH --> LOGOUT[Выход]
    
    REG --> REG1[Проверка email] --> REG2[Хеширование пароля] --> REG3[Создание пользователя] --> REG4[Генерация токенов] --> REG_END([Токены созданы])
    
    LOGIN --> LOGIN1[Поиск пользователя] --> LOGIN2[Проверка пароля] --> LOGIN3[Генерация токенов] --> LOGIN_END([Токены созданы])
    
    API --> API1[Проверка JWT] --> API2{Токен валиден?}
    API2 -->|Да| API3[Выполнение запроса] --> API_END([Успех])
    API2 -->|Нет| API4{Токен истек?}
    API4 -->|Да| API5[Обновление токена] --> API6[Повтор запроса] --> API_END
    API4 -->|Нет| API7[Ошибка авторизации] --> API_ERR([Ошибка])
    
    LOGOUT --> LOGOUT1[Удаление refresh токенов] --> LOGOUT2[Очистка клиента] --> LOGOUT_END([Выход выполнен])
    
    REG_END --> END([Конец])
    LOGIN_END --> END
    API_END --> END
    API_ERR --> END
    LOGOUT_END --> END
```

Ключевые особенности системы:

1. Двух-токенная система - Access (короткий) + Refresh (долгий)
2. Автоматическое обновление - Клиент сам обновляет истекшие токены
3. Безопасное хранение - Refresh tokens в базе, возможность отзыва
4. Статус ошибок - Четкие коды для разных сценариев
5. Масштабируемость - Легко добавить новые провайдеры аутентификации

Эта диаграмма полностью описывает процесс авторизации от регистрации до логаута с автоматическим обновлением токенов.